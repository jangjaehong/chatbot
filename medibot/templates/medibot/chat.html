{% load staticfiles %}
<script>
/* 메세지 DB 저장 및 화면출력 */
function chatting_save(speaker, username, contents){
    $.ajax({
        type: 'POST',
        url:"/save_chatting",
        dataType: 'text',
        data: {
            "speaker": speaker,
            "username": username,
            "contents": contents
        }
        success: function(response){
            addMessage(speaker, username, contents);
        },
        error: function(request, status, error) {
           alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
        }
    });
}

/* 메세지 채팅창에 추가 */
function addMessage(sender, name, message){
    var user_img = "{% static 'medibot/img/icon/ic_user.png' %}";
    var com_img = "{% static 'medibot/img/icon/ic_com.png' %}";
    var speechBubble = '<div class="msg-box ' + sender + ' mb_15">';
    if( sender == 'user'){
        speechBubble += '<div class="profile-wrap"><img src="' + user_img + '"/></div>';
    }else{
        speechBubble += '<div class="profile-wrap"><img src="' + com_img + '"/></div>';
    }
    speechBubble += '<div class="content-wrap">';
    speechBubble += '<div class="name">' + name + '</div>';
    speechBubble += '<div class="content">' + message + '</div>';
    speechBubble += '</div>';
    $('#sentence').append(speechBubble);
};

/* 채팅창 맨아래로 */
function move_chat_scroll(){
    var sentence_last_child = $("#sentence").children(":last");
    var scrollPosition = sentence_last_child.offset().top;
    //alert(scrollPosition);
    $('#sentence').animate({scrollTop : scrollPosition}, 0);
};

/* 채팅에 기능 수행 */
function check_event(flag){
    /* flag==1 : 일일체크 , 2: 식단체크, 3: 기록조회 */
    if(flag == 1){
         chatting_save('com', 'Medi-BOT', "건강상태 시작합니다." );
        $('#physicalFrm').submit();
    }
    if(flag == 2){

        chatting_save('com', 'Medi-BOT', "영양체크를 시작합니다." );
        $('#foodFrm').show();
    }
    if(flag == 3){}
}


/* 취소 버튼 이벤트*/
function diet_check_cancel(){
    $('#foodFrm').animate({display:none});
}

/* 화면 초기화 */
$(document).ready(function(){
    /* 채팅 초기화 */
    {% if chat_reports %}
        {% for report in chat_reports %}
            addMessage('{{ report.speaker }}','{{ report.username }}','{{ report.contents }}');
        {% endfor %}
    {% endif %}

    {% if physical_report %}
        var category = ["체질량지수(BMI)", "복부비만도(WHR)", "기초대사량(kcal)"];
        var value = [physical_report.bmi,  physical_report.whr, physical_report.energy];
        var state = [physical_report.bmi_state, physical_report.whr_state, physical_report.energy_state];
        var age = physical_report.age;
        var gender = physical_report.gender;
        // 결과 표시
        makeBullet(category, value, state, age, gender);
    {% endif %}

    {% if intake_food_report %}
        $('#result-box4).html('');

        var foodAry = new Array(intake_food_report.energy, intake_food_report.gram, intake_food_report.kcal,
        intake_food_report.carbohydrate, intake_food_report.protein, intake_food_report.fat,
        intake_food_report.sugars, intake_food_report.salt, intake_food_report.cholesterol,
        intake_food_report.saturatedfat, intake_food_report.transfat);

        var info = "<table class='tb-diet'>";
        info += "<tr>";
        for(var i=0; i < nutrition.length; i++){
            info += "<th>" + nutrition[i];
        }
        info += "<tr>";
        for(var i=1; i < foodAry.length; i++){
            info += "<td>" + foodAry[i].toFixed(2);
        }
        var resultBox = $('#empty-result-container').clone().show().attr("id","");
        resultBox.find('.title').html("<h4>{{ user.username }}님이 오늘 섭취하신 음식의 영양정보입니다.</h4>");
        resultBox.find('.text-info').html(info);
        resultBox.find('.container').addClass('circle-container').addClass('circle-container1');
        $('#result-box2').append(resultBox);
         var flag = false;
        drawCircleChart(foodAry, "div.circle-container1", flag);
    {% endif %}

    /* 채팅창 스크롤 제일 아래로 */
    move_chat_scroll();
});

/* 이벤트 초기화 묶음 */
$(function() {
    /* 입력 버튼 이벤트 */
    $('#input_message').on('keydown', function(e){
        if(e.keyCode == 13){
            if(e.shiftKey == true){
                var tmp = $('#input_message').val();
                tmp = tmp + "\n";
                $('#input_message').val(tmp)
            }else{
                $('#chatFrm').submit();
            }
            return false;
        }
    });

    /* 채팅 입력 */
     $('#chatFrm').submit(function(e){
        /* 새로 고침 방지 */
        e.preventDefault();
        var input_msg = $('#input_message').val()
        $('#msg').val(input_msg);
        $('#input_message').val('');

        $.ajax({
            type: 'POST',
            url:"/comunication",
            dataType: 'json',
            data: $('#chatFrm').serialize(),
            beforeSend: function(){
                //유저 메세지 표시
                addMessage('user', '{{ user.username }}', input_msg, );
                move_chat_scroll();
            },
            success: function(data, textStatus){
                 $.each(data, function(i, item){
                    addMessage('com', item.name, item.message);
                    if(itme.func != ""){
                        eval(item.func)
                    }
                 });
            },
            complete: function(){
                move_chat_scroll();
            },
            error: function(request, status, error) {
               alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        });
        return false;
    });

    // 식단체크
    $('#foodFrm').submit(function(e){
        e.preventDefault();
        if( $('#fcount').val() == 0){
            alert("오늘 섭취한 음식을 추가해주세요!");
        }else{
            var table_base_info = "<tr id='info_ment' class='info_men'><td colspan='5' height='150' align='center'>음식을 검색 후 선택하시면 추가됩니다.</td></tr>";
            $.ajax({
                type: 'POST',
                url:"/diet",
                dataType: 'json',
                data: $('#foodFrm').serialize(),
                beforeSend: function(){
                    chatting_save('com', 'Medi-BOT', "영양소별 계산중입니다. 잠시만기다려주세요." );
                    $('#foodFrm').hide();
                },
                success: function(data){
                    var nutrition = ["섭취량(g)", "에너지(kcal)", "탄수화물(g)", "단백질(g)", "지방(g)",
                    "당류(g)", "나트륨(mg)", "클레스테롤(mg)", "포화지방(g)", "트랜스지방(g)"];
                    if( data.energy == 0)
                    {
                        alert("상단에 일일점검을 최초 1회이상 하셔야 결과를 확인하실수 있습니다");
                        $("#sel_food_list").html(table_base_info);
                    }else{
                        var foodAry = new Array(data.energy, data.gram, data.kcal, data.carbohydrate, data.protein, data.fat
                        ,data.sugars, data.salt, data.cholesterol ,data.saturatedfat ,data.transfat);

                        var info = "<table class='tb-diet'>";
                        info += "<tr>";
                        for(var i=0; i < nutrition.length; i++){
                            info += "<th>" + nutrition[i];
                        }
                        info += "<tr>";
                        for(var i=1; i < foodAry.length; i++){
                            info += "<td>" + foodAry[i].toFixed(2);
                        }
                        var resultBox = $('#empty-result-container').clone().show().attr("id","");
                        resultBox.find('.title').html("<h4>{{ user.username }}님이 오늘 섭취하신 음식의 영양정보입니다.</h4>");
                        resultBox.find('.text-info').html(info);
                        resultBox.find('.container').addClass('circle-container').addClass('circle-container1');
                        $('#result-box2').append(resultBox);
                         var flag = false;
                        drawCircleChart(foodAry, "div.circle-container1", flag);
                    }
                },
                error: function(request, status, error) {
                   alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                }
            });
            return false;
        }
    });
});
</script>

<!-- 식단체크 데이터 공간-->
<form action="" id="foodFrm" name="foodFrm" class="foodFrm" method="post"  enctype="multipart/form-data">
    <input type="hidden" id="term2" name="term" value="7" />
    <input type="hidden" name="type" value="1" />
    {% csrf_token %}
    <div class="diet-box">
        <input class="searchText" id="searchText" name="searchText" type="text" autocomplete="on" placeholder="음식을 검색해주세요" value=""/>
        <input type="hidden" id="fcount" name="fcount" value="0" />
        <table class="tb-food" id="tb-food">
            <thead>
                <tr>
                    <th>선택음식</th>
                    <th>1회 제공량</th>
                    <th>섭취량</th>
                    <th>분량</th>
                    <th>삭제</th>
                </tr>
            </thead>
            <tbody id="sel_food_list">
                <tr id="info_ment" class="info_ment">
                    <td colspan="5" height="150" align="center">
                        음식을 검색 후 선택하시면 추가됩니다.
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="btn_wrap">
            <input type="submit" id="btn-diet-measure" class="measure-btn" value="확인" />
            <input type="button" id="btn-cancel" value="취소" onclick="diet_check_cancel()"/>
        </div>
    </div>
</form>

<!-- chatting -->
<div id="chat-wrap" class="chat-wrap">
    <form action="" method="post" name="chatFrm" id="chatFrm">
        {% csrf_token %}
        <input type="hidden" id="msg" name="msg" value=""/>
        <div id="chat-header" class="chat-header">
            <div class="tit">Medi-BOT</div>
        </div>
        <div id="chat-box" class="chat-box">
            <div id="sentence" class="sentence"></div>
            <div class="input-wrap">
                <textarea id="input_message" name="input_message" placeholder="Medi-BOT에게 물어보세요!"></textarea>
                <div class="ic_wrap">
                    <div class="img_back"><input type="image" src="{% static 'medibot/img/icon/ic_submit.png' %}" /></div>
                </div>
            </div>
        </div>
    </form>
</div>

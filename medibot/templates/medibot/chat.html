{% load staticfiles %}
<script>
/* 메세지 DB 저장 및 화면출력 */
function chatting_save(speaker, username, contents){
    addMessage(speaker, username, contents);
    $.ajax({
        type: 'POST',
        url:"/save_chatting",
        dataType: 'text',
        data: {
            "speaker": speaker,
            "username": username,
            "contents": contents
        },
        success: function(response){},
        error: function(request, status, error) {
           alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
        }
    });
    return false;
}

/* 메세지 채팅창에 추가 */
function addMessage(sender, name, message){
    var msg_box_len = $('#sentence .msg-box').length;
    alert(msg_box_len);
    var user_img = "{% static 'medibot/img/icon/ic_user.png' %}";
    var com_img = "{% static 'medibot/img/icon/ic_com.png' %}";
    var speechBubble = '<div class="msg-box ' + sender + ' mb_15">';
    if( sender == 'user'){
        speechBubble += '<div class="profile-wrap"><img src="' + user_img + '"/></div>';
    }else{
        speechBubble += '<div class="profile-wrap"><img src="' + com_img + '"/></div>';
    }
    speechBubble += '<div class="content-wrap">';
    speechBubble += '<div class="name">' + name + '</div>';
    speechBubble += '<div class="content" + msg_box_len></div>';
    speechBubble += '</div>';
    $('#sentence').append(speechBubble);
    $('.content' + msg_box_len).html(message.replace("\r\n", "<br />"));
    move_chat_scroll('.content' + msg_box_len);
};

/* 채팅창 맨아래로 */
function move_chat_scroll(element){
    var sentence_last_child = $(element);
    var scrollPosition = sentence_last_child.offset().top;
    //alert(scrollPosition);
    $('#sentence').animate({scrollTop : scrollPosition}, 0);
};

/* 채팅에 기능 수행 */
function check_event(flag){
    /* flag==1 : 일일체크 , 2: 식단체크, 3: 기록조회 */
    if(flag == 1){
        physical_measure();
    }
    if(flag == 2){
        $('#foodFrm').show();
    }
    if(flag == 3){}
}

/* 이벤트 초기화 묶음 */
$(document).ready(function(){
    /* 입력 버튼 이벤트 */
    $('#input_message').on('keydown', function(e){
        if(e.keyCode == 13){
            if(e.shiftKey == true){
                var tmp = $('#input_message').val();
                tmp = tmp + "\n";
                $('#input_message').val(tmp)
            }else{
                $('#chatFrm').submit();
            }
            return false;
        }
    });

    /* 채팅 입력 */
     $('#chatFrm').submit(function(e){
        /* 새로 고침 방지 */
        e.preventDefault();

        /* 사용자 메세지 표시 */
        var input_msg = $('#input_message').val()
        $('#msg').val(input_msg);
        $('#input_message').val('');
        addMessage('user', '{{ user.username }}', input_msg, );

        /* 응답 요청 */
        $.ajax({
            type: 'POST',
            url:"/comunication",
            dataType: 'json',
            data: $('#chatFrm').serialize(),
            success: function(data, textStatus){
                 $.each(data, function(i, item){
                    addMessage(item.speaker, item.name, item.message);
                    var func = item.func;
                    if(func != ""){
                        func = func.replace(/(\s*)/g,"");
                        eval(func);
                    }
                 });
            },
            error: function(request, status, error) {
               alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        });
        return false;
    });
});
</script>

<!-- 식단체크 데이터 공간-->
<form action="" id="foodFrm" name="foodFrm" class="foodFrm" method="post"  enctype="multipart/form-data">
    <input type="hidden" id="term2" name="term" value="7" />
    <input type="hidden" name="type" value="1" />
    {% csrf_token %}
    <div class="diet-box">
        <input class="searchText" id="searchText" name="searchText" type="text" autocomplete="on" placeholder="음식을 검색해주세요" value=""/>
        <input type="hidden" id="fcount" name="fcount" value="0" />
        <table class="tb-food" id="tb-food">
            <thead>
                <tr>
                    <th>선택음식</th>
                    <th>1회 제공량</th>
                    <th>섭취량</th>
                    <th>분량</th>
                    <th>삭제</th>
                </tr>
            </thead>
            <tbody id="sel_food_list">
                <tr id="info_ment" class="info_ment">
                    <td colspan="5" height="150" align="center">
                        음식을 검색 후 선택하시면 추가됩니다.
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="btn_wrap">
            <input type="submit" id="btn-diet-measure" class="measure-btn" value="확인" />
            <input type="button" id="btn-cancel" value="취소" onclick="diet_check_cancel()"/>
        </div>
    </div>
</form>

<!-- chatting -->
<div id="chat-wrap" class="chat-wrap">
    <form action="" method="post" name="chatFrm" id="chatFrm">
        {% csrf_token %}
        <input type="hidden" id="msg" name="msg" value=""/>

        <div id="chat-box" class="chat-box">
            <div id="sentence" class="sentence"></div>
            <div class="input-wrap">
                <textarea id="input_message" name="input_message" placeholder="Medi-BOT에게 물어보세요!"></textarea>
                <div class="ic_wrap">
                    <div class="img_back"><input type="image" src="{% static 'medibot/img/icon/ic_submit.png' %}" /></div>
                </div>
            </div>
        </div>
    </form>
</div>

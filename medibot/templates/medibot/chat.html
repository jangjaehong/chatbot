{% load staticfiles %}
<script>
/* 메세지 채팅창에 추가 */
function addMessage(sender, name, message){
    var user_img = "{% static 'medibot/img/icon/ic_user.png' %}";
    var com_img = "{% static 'medibot/img/icon/ic_com.png' %}";

    var speechBubble = '<div class="msg-box ' + sender + ' mb_15">';
    if( sender == 'user'){
        speechBubble += '<div class="profile-wrap"><img src="' + user_img + '"/></div>';
    }else{
        speechBubble += '<div class="profile-wrap"><img src="' + com_img + '"/></div>';
    }
    speechBubble += '<div class="content-wrap">';
    speechBubble += '<div class="name">' + name + '</div>';
    speechBubble += '<div class="content">' + message + '</div>';
    speechBubble += '</div>';
    $('#sentence').append(speechBubble);

    move_chat_scroll();
};
/* 채팅창 맨아래로 */
function move_chat_scroll(){
    var sentence_last_child = $("#sentence").children(":last");
    var scrollPosition = sentence_last_child.offset().top;
    //alert(scrollPosition);
    $('#sentence').animate({scrollTop : scrollPosition}, 0);
};

/* 채팅에 따른 버튼 보여주기 */
function view_btn_controller(flag){
    $('#btn-controller-wrap').animate({bottom:0});
    $('.check_btn').hide();
    $('#btn_check' + flag).show();
}

// 식단 체크 버튼 이벤트
$('#btn-diet-measure').on('click',function(){
    $('#foodFrm').submit();
});

/* 취소 버튼 이벤트*/
function cancel_event(){
    $('#btn-controller-wrap').animate({bottom:-200});
}
function diet_check_cancel(){
    $('#foodFrm').animate({display:none});
}

/* 일일체크 */
function check_buttons_event(flag){
    cancel_event();
    if(flag == 1){
        /* 일일체크 */
        addMessage('com','Medi-BOT','체질량지수, 복부비만도, 기초대사량 측정을 시작합니다. 조금만 기다려주세요.');
        $('#measureFrm').submit();
    }
    if(flag == 2){
        /* 식단체크 */
        $('#foodFrm').show();
    }
    if(flag == 3){
        /* 기록보기 */
        $('.result-wrap').hide();
        $('.hist-wrap').show();

        $('#hist-box' + flag).empty();
        $('#hist-box' + flag).show();

        if(flag == 1){
            $('.hist-menu').show();
        }else{
            $('.hist-menu').hide();
        }
        $('#hist-type').val(flag);
        $('#histFrm').submit();
    }
}

$(document).ready(function(){
    /* 채팅 초기화 */
    {% if chatreport %}
        {% for report in chatreport %}
            addMessage('{{ report.speaker }}','{{ report.username }}','{{ report.contents }}');
        {% endfor %}
    {% else %}
        addMessage('com','Medi-BOT',"안녕하세요!!! 저는 메디봇이라고 해요~ '도움말'이라고 입력하시면 사용법을 알려드릴게요");
    {% endif %}

    /* 입력 버튼 이벤트 */
    $('#input_message').on('keydown', function(e){
        if(e.keyCode == 13){
            if(e.shiftKey == true){
                var tmp = $('#input_message').val();
                tmp = tmp + "\n";
                $('#input_message').val(tmp)
            }else{
                $('#chatFrm').submit();
                move_chat_scroll();
            }

            return false;
        }
    });
    /* 채팅 입력 */
     $('#chatFrm').submit(function(e){
        /* 새로 고침 방지 */
        e.preventDefault();
        var input_msg = $('#input_message').val()
        $('#msg').val(input_msg);
        $('#input_message').val('');

        $.ajax({
            type: 'POST',
            url:"/ajaxpost",
            dataType: 'json',
            data: $('#chatFrm').serialize(),
            beforeSend: function(){
                //유저 메세지 표시
                addMessage('user', '{{ user.username }}', input_msg, );
                move_chat_scroll();
            },
            success: function(data, textStatus){
                 $.each(data, function(i, item){
                    addMessage('com', item.name, item.message);
                    eval(item.func)
                 });
            },
            complete: function(){
                move_chat_scroll();
            },
            error: function(request, status, error) {
               alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        });
        return false;
    });
});
</script>
<!-- chatting -->
<div id="chat-wrap" class="chat-wrap">
    <form action="" method="post" name="chatFrm" id="chatFrm">
        {% csrf_token %}
        <input type="hidden" id="msg" name="msg" value=""/>
        <div id="chat-header" class="chat-header">
            <div class="tit">Medi-BOT</div>
        </div>
        <div id="chat-box" class="chat-box">
            <div id="sentence" class="sentence"></div>
            <div class="input-wrap">
                <textarea id="input_message" name="input_message" placeholder="Medi-BOT에게 물어보세요!"></textarea>
                <div class="ic_wrap">
                    <div class="img_back"><input type="image" src="{% static 'medibot/img/icon/ic_submit.png' %}" /></div>
                </div>
            </div>
        </div>
        <div id="btn-controller-wrap" class="btn-controller-wrap">
            <div><input type="button" id='btn_check1' class="check_btn" value="일일체크" onclick="check_buttons_event(1)"></div>
            <div><input type="button" id='btn_check2' class="check_btn" value="영양체크" onclick="check_buttons_event(2)"></div>
            <div><input type="button" id="btn-day-cancel"  value="취소"  onclick="cancel_event()"></div>
        </div>
    </form>
</div>

<!-- 식단체크 데이터 공간-->
<form action="" id="foodFrm" name="foodFrm" class="foodFrm" method="post"  enctype="multipart/form-data">
    <input type="hidden" id="term2" name="term" value="7" />
    <input type="hidden" name="type" value="1" />
    {% csrf_token %}
    <div class="input-box">
        <input class="searchText" id="searchText" name="searchText" type="text" autocomplete="on" placeholder="음식을 검색해주세요" value=""/>
        <input type="hidden" id="fcount" name="fcount" value="0" />
        <table class="tb-food" id="tb-food">
            <thead>
                <tr>
                    <th>선택음식</th>
                    <th>1회 제공량</th>
                    <th>섭취량</th>
                    <th>분량</th>
                    <th>삭제</th>
                </tr>
            </thead>
            <tbody id="sel_food_list">
                <tr id="info_ment" class="info_ment">
                    <td colspan="5" height="150" align="center">
                        음식을 검색 후 선택하시면 추가됩니다.
                    </td>
                </tr>
            </tbody>
        </table>
        <!--<div class="btn_wrap">-->
            <!--<input type="button" id="reset-btn" name="reset" class="reset-btn" value="초기화" />-->
        <!--</div>-->
        <div class="btn_wrap">
            <input type="button" id="btn-diet-measure" class="measure-btn" value="확인" />
            <input type="button" id="btn-cancel" value="취소" onclick="diet_check_cancel()"/>
        </div>
    </div>
</form>

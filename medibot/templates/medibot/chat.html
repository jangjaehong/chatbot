{% load staticfiles %}
<script>

/* 그래프 호출 */
function makeBullet(category, value, state, age, gender){
    $('#measure_date').html('최근 측정 날짜 : {{ physical_report.pub_date }}');
    for(var i = 0; i < 3; i++){
        var container = $("#empty-result-container").clone().show().attr("id","");
        container.find(".title").html(category[i])
        container.find(".text-info").html("<p>" + category[i] + ": " + value[i] + "로 " + state[i] + "입니다.</p>");
        container.find(".container").addClass("bullet-container").addClass("bullet-container" + (i + 1));
        $('#result-box' + (i+1)).append(container);
    }
    drawBulletBMI(value[0], state[0], "div.bullet-container1");
    drawBulletWHR(value[1], state[1], gender, age, "div.bullet-container2");
    drawBulletEnergy(value[2], state[2], gender, age, "div.bullet-container3");
}
/* 메세지 채팅창에 추가 */
function addMessage(sender, name, message){
    var user_img = "{% static 'medibot/img/icon/ic_user.png' %}";
    var com_img = "{% static 'medibot/img/icon/ic_com.png' %}";

    var speechBubble = '<div class="msg-box ' + sender + ' mb_15">';
    if( sender == 'user'){
        speechBubble += '<div class="profile-wrap"><img src="' + user_img + '"/></div>';
    }else{
        speechBubble += '<div class="profile-wrap"><img src="' + com_img + '"/></div>';
    }
    speechBubble += '<div class="content-wrap">';
    speechBubble += '<div class="name">' + name + '</div>';
    speechBubble += '<div class="content">' + message + '</div>';
    speechBubble += '</div>';
    $('#sentence').append(speechBubble);

    move_chat_scroll();
};
/* 채팅창 맨아래로 */
function move_chat_scroll(){
    var sentence_last_child = $("#sentence").children(":last");
    var scrollPosition = sentence_last_child.offset().top;
    //alert(scrollPosition);
    $('#sentence').animate({scrollTop : scrollPosition}, 0);
};
/* 채팅에 따른 버튼 보여주기 */
function view_btn_controller(flag){
    $('#btn-controller-wrap').animate({bottom:0});
    $('.check_btn').hide();
    $('#btn_check' + flag).show();
}
/* 버튼 취소 */
function cancel_event(){
    $('#btn-controller-wrap').animate({bottom:-200});
}
/* 기록 보기 */
function hist_hutton_event(flag){
    $('.result-wrap').hide();
    $('.hist-wrap').show();

    $('#hist-box' + flag).empty();
    $('#hist-box' + flag).show();

    if(flag == 1){
        $('.hist-menu').show();
    }else{
        $('.hist-menu').hide();
    }
    $('#hist-type').val(flag);
    $('#histFrm').submit();
}
/* 일일체크 */
function check_buttons_event(flag){
    cancel_event();
    if(flag == 1){
        /* 일일체크 */
        addMessage('com','Medi-BOT','체질량지수, 복부비만도, 기초대사량 측정을 시작합니다. 조금만 기다려주세요.');
        $('#measureFrm').submit();
    }
    if(flag == 2){
        $('#content-box2').show();
    }
}

$(document).ready(function(){
    $('.result-box').hide();
    $('#result-box1').show();
    /* 채팅 초기화 */
    {% if chatreport %}
        {% for report in chatreport %}
            addMessage('{{ report.speaker }}','{{ report.username }}','{{ report.contents }}');
        {% endfor %}
    {% else %}
        addMessage('com','Medi-BOT',"안녕하세요!!! 저는 메디봇이라고 해요~ '도움말'이라고 입력하시면 사용법을 알려드릴게요");
    {% endif %}

    /* 입력 버튼 이벤트 */
    $('#input_message').on('keydown', function(e){
        if(e.keyCode == 13){
            if(e.shiftKey == true){
                var tmp = $('#input_message').val();
                tmp = tmp + "\n";
                $('#input_message').val(tmp)
            }else{
                $('#chatFrm').submit();
                move_chat_scroll();
            }

            return false;
        }
    });
    /* 채팅 입력 */
     $('#chatFrm').submit(function(e){
        /* 새로 고침 방지 */
        e.preventDefault();
        var input_msg = $('#input_message').val()
        $('#msg').val(input_msg);
        $('#input_message').val('');

        $.ajax({
            type: 'POST',
            url:"/ajaxpost",
            dataType: 'json',
            data: $('#chatFrm').serialize(),
            beforeSend: function(){
                //유저 메세지 표시
                addMessage('user', '{{ user.username }}', input_msg, );
                move_chat_scroll();
            },
            success: function(data, textStatus){
                 $.each(data, function(i, item){
                    addMessage('com', item.name, item.message);
                    eval(item.func)
                 });
            },
            complete: function(){
                move_chat_scroll();
            },
            error: function(request, status, error) {
               alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        });
        return false;
    });
    $('#measureFrm').submit(function(){
        alert("측정을 위한 ajax 통신 시작");
        $.ajax({
            type: 'POST',
            url:"/day_measure",
            dataType: 'json',
            data: $('#measureFrm').serialize(),
            beforeSend: function(){
                //유저 메세지 표시
            },
            success: function(response){
                // 결과데이터
                var category = ["체질량지수(BMI)", "복부비만도(WHR)", "기초대사량(kcal)"];
                var value = [response.bmi,  response.whr, response.energy];
                var state = [response.bmi_state, response.whr_state, response.energy_state];
                var age = response.age;
                var gender = response.gender;
                // 결과 표시
                makeBullet(category, value, state, age, gender);
            },
            error: function(request, status, error) {
               alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        });
        return false;
    });

    // 기록보기
    $('#histFrm').submit(function(e){
        var gubun = $('#hist-gubun').val();
        var type = $('#hist-type').val();
        e.preventDefault();
        $.ajax({
            type: 'POST',
            url:"/hist",
            dataType: 'json',
            data: $('#histFrm').serialize(),
            beforeSend: function(){
                //유저 메세지 표시
            },
            success: function(data){
                if(data.length == 0){
                    if(type == "1")
                        alert("기록이 없습니다. 먼저 일일체크 측정을 해보시기 바랍니다.");
                    if(type == "2")
                        alert("기록이 없습니다. 먼저 식단체크 측정을 해보시기 바랍니다.");
                }else{
                    var resultBox = $('#empty-result-container').clone().show().attr("id","");
                    resultBox.find('.title').remove();
                    resultBox.find('.text-info').remove();
                    resultBox.find('.container').addClass('hist-container').addClass('hist-container' + type);
                    if(type == 1){
                        $('#hist-box1').append(resultBox);
                        if(gubun == 1) {
                            drawCurveBMI(data, 'div.hist-container' + type);
                        }
                        else if(gubun == 2){
                            drawCurveWHR(data, 'div.hist-container' + type, data[data.length-1].gender);
                        }
                        else if(gubun == 3){
                            drawCurveEnergy(data, 'div.hist-container' + type, data[data.length-1].gender, data[data.length-1].age);
                        }
                    }
                    if(type == 2){
                        $('#hist-box2').append(resultBox);
                        drawCurveChart(data, 'div.hist-container' + type);
                    }
                }
            },
            error: function(request, status, error) {
               alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        });
    });

    // 결과창 메뉴 이벤트
    $('#hist-menu li').on('click',function(){
        var gubun = $(this).attr('id').replace('hist','');
        $('#hist-menu li').removeClass('on');
        $(this).addClass('on')

        $('#hist-gubun').val(gubun);
        $('#histFrm').submit();
    });
});
</script>
<!-- chatting -->
<form action="" method="post" name="chatFrm" id="chatFrm">
    {% csrf_token %}
    <input type="hidden" id="msg" name="msg" value=""/>
    <div id="chat-wrap" class="chat-wrap">
        <div id="chat-header" class="chat-header">
            <div class="sub-tit">Medi-BOT</div>
            <div class="close" id="chat-close">x</div>
        </div>
        <div id="chat-box" class="chat-box">
            <div id="sentence" class="sentence"></div>
            <div class="input-wrap">
                <textarea id="input_message" name="input_message" placeholder="Medi-BOT에게 물어보세요!"></textarea>
                <div class="ic_wrap">
                    <div class="img_back"><input type="image" src="{% static 'medibot/img/icon/ic_submit.png' %}" /></div>
                </div>
            </div>
        </div>
        <div id="btn-controller-wrap" class="btn-controller-wrap">
            <div><input type="button" id='btn_check1' class="check_btn" value="DayCheck" onclick="check_buttons_event(1)"></div>
            <div><input type="button" id='btn_check2' class="check_btn" value="DietCheck" onclick="check_buttons_event(2)"></div>
            <div><input type="button" id="btn_day_history" value="기록보기" onclick="check_buttons_event(3)"></div>
            <div><input type="button" id="btn_day-cancel"  value="취소"  onclick="cancel_event()"></div>
        </div>
    </div>
</form>

<form action="" id="measureFrm" name="measureFrm" method="post" enctype="multipart/form-data">
    <input type="hidden" name="gender" value="{{ physical_report.gender }}">
    <input type="hidden" name="age" value="{{ physical_report.age }}" >
    <input type="hidden" name="stature" value="{{ physical_report.stature }}"/>
    <input type="hidden" name="weight" value="{{ physical_report.weight }}"/>
    <input type="hidden" name="waist" value="{{ physical_report.waist }}">
    <input type="hidden" name="hip" value="{{ physical_report.hip }}">
</form>

<!-- 기록보기 -->
<form action="" id="histFrm" name="physicalFrm" method="post" enctype="multipart/form-data">
    <input type="hidden" id="hist-term" name="term" value="7" />
    <input type="hidden" id="hist-type" name="type" value="1" />
    <input type="hidden" id="hist-gubun" name="gubun" value="1" />
</form>
